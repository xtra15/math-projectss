<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interactive Wheels System</title>
    <style>
        /* Your existing CSS styles */
        /* --- Theme: Default --- */
        /* CSS Background animations are removed, canvas will handle dynamic backgrounds */

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            position: fixed;
            width: 100%;
            touch-action: none;
            overflow: hidden;
            transition: background-color 0.5s ease; /* For solid bg color changes */
        }

        body.theme-default {
            background-color: #e0e8f0; /* Base for default */
        }
        body.theme-default .section-label { color: black; text-shadow: 0 0 8px white, 0 0 10px white; } /* White glow */
        body.theme-default .modal-content, body.theme-default .nested-modal-content { background-color: #fefefe; color: #333; }
        body.theme-default .modal-title { color: #2970db; }
        body.theme-default .text-box { background-color: rgba(255, 255, 255, 0.8); border: 2px solid #2970db; color: #2970db; }
        body.theme-default .text-box:hover { background-color: #2970db; color: white; }
        /* Default Wheel Colors */
        body.theme-default .wheel-larger,
        body.theme-default .wheel-large,
        body.theme-default .wheel-medium,
        body.theme-default .wheel-small {
            background: conic-gradient(#FF1493 0% 16.67%, #FF6347 16.67% 33.33%, #F0E68C 33.33% 50%, #00FF7F 50% 66.67%, #1E90FF 66.67% 83.33%, #DDA0DD 83.33% 100%) !important;
        }
        body.theme-default .section-divider {
            background-color: white !important; /* Ensure override */
            height: 3px !important; /* Ensure override and make thicker */
        }


        body.theme-deep-ocean {
            background-color: #0f2027; /* Base for deep ocean */
        }
        body.theme-deep-ocean .wheel-part { background-color: #2c5364; } /* Themed wheel part */
        body.theme-deep-ocean .section-label { color: #e0e8f0; text-shadow: 0 0 2px #0f2027; }
        body.theme-deep-ocean .modal-content, body.theme-deep-ocean .nested-modal-content { background-color: #1a2c3a; color: #e0e8f0; border-color: #3a506b; }
        body.theme-deep-ocean .modal-title { color: #64B5F6; }
        body.theme-deep-ocean .text-box { background-color: rgba(44, 83, 100, 0.8); border: 2px solid #64B5F6; color: #e0e8f0; }
        body.theme-deep-ocean .text-box:hover { background-color: #64B5F6; color: #0f2027; }
        body.theme-deep-ocean #nested-modal-content strong { color: #64B5F6; }
        body.theme-deep-ocean .content-box { background-color: #203a43; border-color: #2c5364; color: #e0e8f0;}
        body.theme-deep-ocean .content-box:hover { background-color: #2c5364; }
        body.theme-deep-ocean .close-btn { color: #ff7e5f; }
        body.theme-deep-ocean .close-btn:hover { color: #feb47b; }
        body.theme-deep-ocean .section-divider { background-color: rgba(100, 181, 246, 0.3); } /* Light Blue Divider */
        /* Deep Ocean Wheel Colors - Consistent Gradient */
        body.theme-deep-ocean .wheel-larger,
        body.theme-deep-ocean .wheel-large,
        body.theme-deep-ocean .wheel-medium,
        body.theme-deep-ocean .wheel-small {
            background: conic-gradient(#0f2027 0% 12.5%, #1a2c3a 12.5% 25%, #203a43 25% 37.5%, #2c5364 37.5% 50%, #3a506b 50% 62.5%, #2c5364 62.5% 75%, #203a43 75% 87.5%, #1a2c3a 87.5% 100%) !important;
        }


        /* --- Theme: Minty Fresh (Revised - Subdued) --- */
        body.theme-minty-fresh {
            background-color: #D0E0E3; /* Base for minty fresh */
        }
        body.theme-minty-fresh .wheel-part { background-color: #B0CCD0; } /* Themed wheel part */
        body.theme-minty-fresh .section-label { color: #37474F; text-shadow: 0 0 2px #D0E0E3; } /* Dark Slate Grey */
        body.theme-minty-fresh .modal-content, body.theme-minty-fresh .nested-modal-content { background-color: #F0F4F8; color: #455A64; border-color: #B0CCD0; }
        body.theme-minty-fresh .modal-title { color: #546E7A; } /* Slate Grey */
        body.theme-minty-fresh .text-box { background-color: rgba(176, 204, 208, 0.7); border: 2px solid #546E7A; color: #37474F; }
        body.theme-minty-fresh .text-box:hover { background-color: #546E7A; color: #F0F4F8; }
        body.theme-minty-fresh #nested-modal-content strong { color: #546E7A; }
        body.theme-minty-fresh .content-box { background-color: #C0D6D9; border-color: #B0CCD0; color: #37474F;}
        body.theme-minty-fresh .content-box:hover { background-color: #B0CCD0; }
        body.theme-minty-fresh .close-btn { color: #78909C; } /* Muted Red */
        body.theme-minty-fresh .close-btn:hover { color: #607D8B; }
        body.theme-minty-fresh .section-divider { background-color: rgba(69, 90, 100, 0.3); }
        body.theme-minty-fresh .wheel-larger,
        body.theme-minty-fresh .wheel-large,
        body.theme-minty-fresh .wheel-medium,
        body.theme-minty-fresh .wheel-small {
            background: conic-gradient(#78909C 0% 12.5%, #607D8B 12.5% 25%, #546E7A 25% 37.5%, #455A64 37.5% 50%, #37474F 50% 62.5%, #455A64 62.5% 75%, #546E7A 75% 87.5%, #607D8B 87.5% 100%) !important; /* Muted Teals/Greens */
        }

        /* --- Theme: Cool Slate (Unchanged, already subdued) --- */
        body.theme-cool-slate {
            background-color: #455a64; /* Base for cool slate */
        }
        body.theme-cool-slate .wheel-part { background-color: #546e7a; } /* Themed wheel part */
        body.theme-cool-slate .section-label { color: #eceff1; text-shadow: 0 0 2px #263238; }
        body.theme-cool-slate .modal-content, body.theme-cool-slate .nested-modal-content { background-color: #37474f; color: #cfd8dc; border-color: #546e7a; }
        body.theme-cool-slate .modal-title { color: #90a4ae; }
        body.theme-cool-slate .text-box { background-color: rgba(69, 90, 100, 0.8); border: 2px solid #90a4ae; color: #eceff1; }
        body.theme-cool-slate .text-box:hover { background-color: #90a4ae; color: #263238; }
        body.theme-cool-slate #nested-modal-content strong { color: #90a4ae; }
        body.theme-cool-slate .content-box { background-color: #455a64; border-color: #546e7a; color: #eceff1;}
        body.theme-cool-slate .content-box:hover { background-color: #546e7a; }
        body.theme-cool-slate .close-btn { color: #ef9a9a; }
        body.theme-cool-slate .close-btn:hover { color: #e57373; }
        body.theme-cool-slate .section-divider { background-color: rgba(207, 216, 220, 0.3); }
        body.theme-cool-slate .wheel-larger,
        body.theme-cool-slate .wheel-large,
        body.theme-cool-slate .wheel-medium,
        body.theme-cool-slate .wheel-small {
            background: conic-gradient(#546e7a 0% 12.5%, #455a64 12.5% 25%, #37474f 25% 37.5%, #263238 37.5% 50%, #37474f 50% 62.5%, #455a64 62.5% 75%, #546e7a 75% 87.5%, #607d8b 87.5% 100%) !important;
        }

        /* --- Theme: Earthy Tones --- */
        body.theme-earthy-tones {
            background-color: #A0937D; /* Base for earthy tones */
        }
        body.theme-earthy-tones .wheel-part { background-color: #B4A582; } /* Themed wheel part */
        body.theme-earthy-tones .section-label { color: #4E443A; text-shadow: 0 0 2px #F5F0E6; } /* Dark Brown */
        body.theme-earthy-tones .modal-content, body.theme-earthy-tones .nested-modal-content { background-color: #F5F0E6; color: #5D4037; border-color: #C8B787; }
        body.theme-earthy-tones .modal-title { color: #8D6E63; } /* Brown */
        body.theme-earthy-tones .text-box { background-color: rgba(180, 165, 130, 0.7); border: 2px solid #8D6E63; color: #4E443A; }
        body.theme-earthy-tones .text-box:hover { background-color: #8D6E63; color: #F5F0E6; }
        body.theme-earthy-tones #nested-modal-content strong { color: #8D6E63; }
        body.theme-earthy-tones .content-box { background-color: #B4A582; border-color: #C8B787; color: #4E443A;}
        body.theme-earthy-tones .content-box:hover { background-color: #C8B787; }
        body.theme-earthy-tones .close-btn { color: #A1887F; }
        body.theme-earthy-tones .close-btn:hover { color: #8D6E63; }
        body.theme-earthy-tones .section-divider { background-color: rgba(78, 68, 58, 0.3); }
        body.theme-earthy-tones .wheel-larger,
        body.theme-earthy-tones .wheel-large,
        body.theme-earthy-tones .wheel-medium,
        body.theme-earthy-tones .wheel-small {
            background: conic-gradient(#8D6E63 0% 12.5%, #A1887F 12.5% 25%, #B4A582 25% 37.5%, #C8B787 37.5% 50%, #A0937D 50% 62.5%, #C8B787 62.5% 75%, #B4A582 75% 87.5%, #A1887F 87.5% 100%) !important; /* Browns and Beiges */
        }

        /* --- Theme: Monochrome Calm --- */
        body.theme-monochrome-calm {
            background-color: #BDC3C7; /* Base for monochrome calm */
        }
        body.theme-monochrome-calm .wheel-part { background-color: #CACFD2; } /* Themed wheel part */
        body.theme-monochrome-calm .section-label { color: #2C3E50; text-shadow: 0 0 2px #BDC3C7; } /* Dark Slate */
        body.theme-monochrome-calm .modal-content, body.theme-monochrome-calm .nested-modal-content { background-color: #F4F6F6; color: #34495E; border-color: #BDC3C7; }
        body.theme-monochrome-calm .modal-title { color: #7F8C8D; } /* Grey */
        body.theme-monochrome-calm .text-box { background-color: rgba(189, 195, 199, 0.7); border: 2px solid #7F8C8D; color: #2C3E50; }
        body.theme-monochrome-calm .text-box:hover { background-color: #7F8C8D; color: #F4F6F6; }
        body.theme-monochrome-calm #nested-modal-content strong { color: #7F8C8D; }
        body.theme-monochrome-calm .content-box { background-color: #CACFD2; border-color: #BDC3C7; color: #2C3E50;}
        body.theme-monochrome-calm .content-box:hover { background-color: #BDC3C7; }
        body.theme-monochrome-calm .close-btn { color: #95A5A6; }
        body.theme-monochrome-calm .close-btn:hover { color: #7F8C8D; }
        body.theme-monochrome-calm .section-divider { background-color: rgba(44, 62, 80, 0.3); }
        body.theme-monochrome-calm .wheel-larger,
        body.theme-monochrome-calm .wheel-large,
        body.theme-monochrome-calm .wheel-medium,
        body.theme-monochrome-calm .wheel-small {
            background: conic-gradient(#7F8C8D 0% 12.5%, #95A5A6 12.5% 25%, #BDC3C7 25% 37.5%, #CACFD2 37.5% 50%, #D6DBDF 50% 62.5%, #CACFD2 62.5% 75%, #BDC3C7 75% 87.5%, #95A5A6 87.5% 100%) !important; /* Shades of Grey */
        }

        /* Soft Lavender Theme Removed */

        /* --- Theme: Forest Canopy --- */
        body.theme-forest-canopy {
            background-color: #2F4F4F; /* Dark Slate Gray - Base for Forest Canopy */
        }
         body.theme-forest-canopy .wheel-part { background-color: #054e2a; } 
        body.theme-forest-canopy .section-label { color: #F0FFF0; text-shadow: 0 0 2px #2F4F4F; } /* Honeydew */
        body.theme-forest-canopy .modal-content, body.theme-forest-canopy .nested-modal-content { background-color: #556B2F; color: #F0FFF0; border-color: #8FBC8F; } /* Dark Olive Green, Honeydew text, Dark Sea Green border */
        body.theme-forest-canopy .modal-title { color: #ADFF2F; } /* Green Yellow */
        body.theme-forest-canopy .text-box { background-color: rgba(85, 107, 47, 0.7); border: 2px solid #ADFF2F; color: #F0FFF0; }
        body.theme-forest-canopy .text-box:hover { background-color: #ADFF2F; color: #2F4F4F; }
        body.theme-forest-canopy #nested-modal-content strong { color: #ADFF2F; }
        body.theme-forest-canopy .content-box { background-color: #8FBC8F; border-color: #ADFF2F; color: #2F4F4F;} /* Dark Sea Green, Green Yellow border */
        body.theme-forest-canopy .content-box:hover { background-color: #98FB98; } /* Pale Green */
        body.theme-forest-canopy .close-btn { color: #90EE90; } /* Light Green */
        body.theme-forest-canopy .close-btn:hover { color: #ADFF2F; }
        body.theme-forest-canopy .section-divider { background-color: rgba(173, 255, 47, 0.3); } /* Green Yellow divider */
        body.theme-forest-canopy .wheel-part { background-color: #556B2F; } /* Dark Olive Green for wheel part */
        body.theme-forest-canopy .wheel-larger,
        body.theme-forest-canopy .wheel-large,
        body.theme-forest-canopy .wheel-medium,
        body.theme-forest-canopy .wheel-small {
            background: conic-gradient(#2E8B57 0% 12.5%, #3CB371 12.5% 25%, #66CDAA 25% 37.5%, #8FBC8F 37.5% 50%, #556B2F 50% 62.5%, #8FBC8F 62.5% 75%, #66CDAA 75% 87.5%, #3CB371 87.5% 100%) !important; /* Sea Greens, Olive Drab */
        }

        /* --- Theme: Stormy Sky --- */
        body.theme-stormy-sky {
            background: linear-gradient(to bottom, #2c3e50, #34495e, #233142); /* Dark blue/grey gradient */
        }
        body.theme-stormy-sky .wheel-part { background-color: #424575;  }
        body.theme-stormy-sky .section-label { color: #ecf0f1; text-shadow: 0 0 3px #2c3e50; }
        body.theme-stormy-sky .modal-content, body.theme-stormy-sky .nested-modal-content { background-color: #34495e; color: #ecf0f1; border-color: #4a6572; }
        body.theme-stormy-sky .modal-title { color: #f1c40f; } /* Yellow for contrast */
        body.theme-stormy-sky .text-box { background-color: rgba(44, 62, 80, 0.8); border: 2px solid #f1c40f; color: #ecf0f1; }
        body.theme-stormy-sky .text-box:hover { background-color: #f1c40f; color: #2c3e50; }
        body.theme-stormy-sky #nested-modal-content strong { color: #f1c40f; }
        body.theme-stormy-sky .content-box { background-color: #4a6572; border-color: #f1c40f; color: #ecf0f1;}
        body.theme-stormy-sky .content-box:hover { background-color: #5b7c8d; }
        body.theme-stormy-sky .close-btn { color: #e74c3c; }
        body.theme-stormy-sky .close-btn:hover { color: #c0392b; }
        body.theme-stormy-sky .section-divider { background-color: rgba(241, 196, 15, 0.3); }
        body.theme-stormy-sky .wheel-part { background-color: #4a6572; }
        body.theme-stormy-sky .wheel-larger,
        body.theme-stormy-sky .wheel-large,
        body.theme-stormy-sky .wheel-medium,
        body.theme-stormy-sky .wheel-small {
            background: conic-gradient(#2c3e50 0% 12.5%, #34495e 12.5% 25%, #4a6572 25% 37.5%, #233142 37.5% 50%, #4a6572 50% 62.5%, #34495e 62.5% 75%, #2c3e50 75% 87.5%, #233142 87.5% 100%) !important;
        }

        /* --- Theme: Lightning Strike --- */
        body.theme-lightning-strike {
            background-color: #101020; /* Dark night sky */
        }
          body.theme-lightning-strike .wheel-part { background-color: #424575;  }
        body.theme-lightning-strike .section-label { color: #E0E0FF; text-shadow: 0 0 3px #000030; }
        body.theme-lightning-strike .modal-content, body.theme-lightning-strike .nested-modal-content { background-color: #202030; color: #E0E0FF; border-color: #404060; }
        body.theme-lightning-strike .modal-title { color: #A0A0FF; }
        body.theme-lightning-strike .text-box { background-color: rgba(40, 40, 60, 0.8); border: 2px solid #A0A0FF; color: #E0E0FF; }
        body.theme-lightning-strike .text-box:hover { background-color: #A0A0FF; color: #101020; }
        body.theme-lightning-strike #nested-modal-content strong { color: #A0A0FF; }
        body.theme-lightning-strike .content-box { background-color: #303045; border-color: #A0A0FF; color: #E0E0FF;}
        body.theme-lightning-strike .content-box:hover { background-color: #404060; }
        body.theme-lightning-strike .close-btn { color: #FF6060; }
        body.theme-lightning-strike .close-btn:hover { color: #FF3030; }
        body.theme-lightning-strike .section-divider { background-color: rgba(160, 160, 255, 0.3); }
        body.theme-lightning-strike .wheel-larger,
        body.theme-lightning-strike .wheel-large,
        body.theme-lightning-strike .wheel-medium,
        body.theme-lightning-strike .wheel-small {
            background: conic-gradient(#202040 0% 12.5%, #303050 12.5% 25%, #404060 25% 37.5%, #505070 37.5% 50%, #404060 50% 62.5%, #303050 62.5% 75%, #202040 75% 87.5%, #101030 87.5% 100%) !important;
        }

        /* --- Theme: Sky Clouds --- */
        body.theme-sky-clouds {
            background-color: #87CEEB; /* Sky blue */
        }
        body.theme-sky-clouds  .wheel-part { background-color: #03A9F4; }
        body.theme-sky-clouds .section-label { color: #00008B; text-shadow: 0 0 3px #ADD8E6; } /* DarkBlue text, LightBlue shadow */
        body.theme-sky-clouds .modal-content, body.theme-sky-clouds .nested-modal-content { background-color: #F0F8FF; color: #191970; border-color: #B0E0E6; } /* AliceBlue bg, MidnightBlue text, PowderBlue border */
        body.theme-sky-clouds .modal-title { color: #4682B4; } /* SteelBlue */
        body.theme-sky-clouds .text-box { background-color: rgba(173, 216, 230, 0.8); border: 2px solid #4682B4; color: #00008B; }
        body.theme-sky-clouds .text-box:hover { background-color: #4682B4; color: #F0F8FF; }
        body.theme-sky-clouds #nested-modal-content strong { color: #4682B4; }
        body.theme-sky-clouds .content-box { background-color: #ADD8E6; border-color: #B0E0E6; color: #00008B;}
        body.theme-sky-clouds .content-box:hover { background-color: #B0E0E6; }
        body.theme-sky-clouds .close-btn { color: #FF6347; } /* Tomato */
        body.theme-sky-clouds .close-btn:hover { color: #FF4500; } /* OrangeRed */
        body.theme-sky-clouds .section-divider { background-color: rgba(255, 255, 255, 0.4); }
        body.theme-sky-clouds .wheel-larger,
        body.theme-sky-clouds .wheel-large,
        body.theme-sky-clouds .wheel-medium,
        body.theme-sky-clouds .wheel-small {
            background: conic-gradient(#ADD8E6 0% 12.5%, #B0E0E6 12.5% 25%, #87CEFA 25% 37.5%, #00BFFF 37.5% 50%, #1E90FF 50% 62.5%, #00BFFF 62.5% 75%, #87CEFA 75% 87.5%, #B0E0E6 87.5% 100%) !important;
        }

        /* --- Theme: Sunset Gradient --- */
        body.theme-sunset-gradient {
            background: linear-gradient(to bottom, #FF8C00, #FFD700, #F0E68C); /* Orange to Gold to Khaki */
        }
       body.theme-sunset-gradient .wheel-part {background-color: #f0d068;}
        body.theme-sunset-gradient .section-label { color: #4A3B00; text-shadow: 0 0 3px #FFFACD; } /* Dark Gold text, LemonChiffon shadow */
        body.theme-sunset-gradient .modal-content, body.theme-sunset-gradient .nested-modal-content { background-color: #FFF8DC; color: #8B4513; border-color: #FFD700; } /* Cornsilk bg, SaddleBrown text, Gold border */
        body.theme-sunset-gradient .modal-title { color: #FF8C00; } /* DarkOrange */
        body.theme-sunset-gradient .text-box { background-color: rgba(255, 215, 0, 0.7); border: 2px solid #FF8C00; color: #8B4513; }
        body.theme-sunset-gradient .text-box:hover { background-color: #FF8C00; color: #FFF8DC; }
        body.theme-sunset-gradient #nested-modal-content strong { color: #FF8C00; }
        body.theme-sunset-gradient .content-box { background-color: #FFFACD; border-color: #FFD700; color: #8B4513;}
        body.theme-sunset-gradient .content-box:hover { background-color: #FFEFD5; } /* PapayaWhip */
        body.theme-sunset-gradient .close-btn { color: #DC143C; } /* Crimson */
        body.theme-sunset-gradient .close-btn:hover { color: #B22222; } /* Firebrick */
        body.theme-sunset-gradient .section-divider { background-color: rgba(255, 255, 255, 0.3); }
        /* Sunset Gradient Wheel Colors */
        body.theme-sunset-gradient .wheel-larger,
        body.theme-sunset-gradient .wheel-large,
        body.theme-sunset-gradient .wheel-medium,
        body.theme-sunset-gradient .wheel-small {
            background: conic-gradient(#FF8C00 0% 12.5%, #FFA500 12.5% 25%, #FFD700 25% 37.5%, #FFFFE0 37.5% 50%, #F0E68C 50% 62.5%, #FFFFE0 62.5% 75%, #FFD700 75% 87.5%, #FFA500 87.5% 100%) !important;
        }

        /* --- Theme: Thunderstorm --- */
        body.theme-thunderstorm {
            background-color: #050510; /* Very dark, near black */
        }
        body.theme-thunderstorm .wheel-part {background-color: #3c3c6d;}
        body.theme-thunderstorm .section-label { color: #E8E8FF; text-shadow: 0 0 4px #3f3f7e; } /* Light electric blue/lavender */
        body.theme-thunderstorm .modal-content, body.theme-thunderstorm .nested-modal-content { background-color: #101020; color: #D0D0F0; border-color: #303050; }
        body.theme-thunderstorm .modal-title { color: #8080FF; } /* Electric blue */
        body.theme-thunderstorm .text-box { background-color: rgba(30, 30, 50, 0.8); border: 2px solid #8080FF; color: #E8E8FF; }
        body.theme-thunderstorm .text-box:hover { background-color: #8080FF; color: #050510; }
        body.theme-thunderstorm #nested-modal-content strong { color: #8080FF; }
        body.theme-thunderstorm .content-box { background-color: #202035; border-color: #8080FF; color: #E8E8FF;}
        body.theme-thunderstorm .content-box:hover { background-color: #303050; }
        body.theme-thunderstorm .close-btn { color: #FF8080; } /* Electric pink/red */
        body.theme-thunderstorm .close-btn:hover { color: #FF5050; }
        body.theme-thunderstorm .section-divider { background-color: rgba(128, 128, 255, 0.3); }
        body.theme-thunderstorm .wheel-larger,
        body.theme-thunderstorm .wheel-large,
        body.theme-thunderstorm .wheel-medium,
        body.theme-thunderstorm .wheel-small {
            background: conic-gradient(#101030 0% 12.5%, #202040 12.5% 25%, #303050 25% 37.5%, #282860 37.5% 50%, #303050 50% 62.5%, #202040 62.5% 75%, #101030 75% 87.5%, #080820 87.5% 100%); /* Dark blues and purples */
        }

        #theme-switcher {
            position: fixed;
            top: 90px; /* Adjusted to be lower */
            right: 20px;
            padding: 10px 15px;
            background-color: #2970db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100; /* Above most elements */
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }

        #theme-switcher:hover {
            background-color: #1E88E5;
        }
#particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Place it behind all other content */
            pointer-events: none; /* Make sure it doesn't interfere with interactions */
        }

        body, html {
            overflow: hidden;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        .wheel-container {
            position: relative;
            width: 800px;
            height: 800px;
            transform-origin: center center;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }

        .wheel-container.hidden {
            opacity: 0;
        }

        .wheel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            -webkit-transform: translate(-50%, -50%);
            -moz-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            box-shadow: 0 0 0 2px #FFFFFF; /* White outline for wheels */
        }

        .wheel-large {
            width: 800px;
            height: 800px;
            z-index: 1;
            background: conic-gradient(
                #2970db 0% 12.5%, 
                #3179cc 12.5% 25%, 
                #1976D2 25% 37.5%, 
                #1E88E5 37.5% 50%, 
                #2196F3 50% 62.5%, 
                #42A5F5 62.5% 75%, 
                #64B5F6 75% 87.5%, 
                #90CAF9 87.5% 100%
            );
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .wheel-medium {
            width: 530px;
            height: 530px;
            z-index: 2;
            background: conic-gradient(
                #007fe0 0% 12.5%, 
                #008bdb 12.5% 25%, 
                #0288D1 25% 37.5%, 
                #039BE5 37.5% 50%, 
                #03A9F4 50% 62.5%, 
                #29B6F6 62.5% 75%, 
                #4FC3F7 75% 87.5%, 
                #58c5f8 87.5% 100%
            );
        }

        .wheel-small {
            width: 200px;
            height: 200px;
            z-index: 3;
            background: conic-gradient(
                #0D47A1 0% 25%, 
                #1976D2 25% 50%, 
                #2196F3 50% 75%, 
                #64B5F6 75% 100%
            );
        }

        .wheel-larger {
    width: 900px;
    height: 900px;
    z-index: 0;
    background: conic-gradient(
        #1976D2 0% 25%, 
        #1976D2 25% 50%, 
        #2196F3 50% 75%, 
        #64B5F6 75% 100%
    );
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

        .section-divider {
            position: absolute;
            top: 50%;
            left: 50%;
            height: 2px;
            background-color: rgba(255, 255, 255, 0.2);
            transform-origin: left center;
            z-index: 10;
            pointer-events: none;
        }

        .section-label {
            position: absolute;
            background-color: transparent;
            color: black;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            transform: translate(-50%, -50%);
            z-index: 15;
            pointer-events: all;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            text-align: center;
        }

        .clickable-label {
            cursor: pointer;
            transition: transform 0.2s, text-shadow 0.2s;
            padding: 10px;
            min-height: 44px;
            min-width: 44px;
        }

        .clickable-label:hover {
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.7);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            touch-action: none;
        }

        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: 0;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            touch-action: pan-y;
            max-height: 90vh;
            overflow-y: auto;
        }

        .nested-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            touch-action: none;
        }

        .nested-modal-content {
    background-color: #fefefe;
    margin: 0;
    padding: 20px;
    border: 1px solid #888;
    width: 90%;
    max-width: 500px;
    border-radius: 8px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-height: 90vh;
    overflow: auto !important; /* Make sure it's scrollable */
    touch-action: pan-y;
    text-align: left !important;
    font-family: Arial, sans-serif; /* Changed from monospace for better readability */
    line-height: 1.4;
}

#nested-modal-content {
    word-wrap: break-word;
    text-align: left;
    padding: 5px 0;
}

#nested-modal-content strong {
    color: #2970db;
    font-weight: bold;
}
        #modal-content, #nested-modal-content {
            white-space: pre-wrap !important;
            word-wrap: break-word;
            word-break: keep-all;
            text-align: left;
        }

        .content-box {
            background-color: #f8f9fa;
            padding: 25px;
            margin: 15px auto;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            font-size: 16px;
            max-width: 90%;
            text-align: center;
            min-height: 44px;
        }

        .content-box:hover {
            background-color: #e9ecef;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .modal-title {
            margin-top: 0;
            color: #2970db;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            font-size: 24px;
        }

        .modal-body {
            margin: 20px 0;
            font-size: 18px;
            line-height: 1.6;
        }

        .close-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            color: #ff0000;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            min-height: 44px;
            min-width: 44px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #000;
            text-decoration: none;
        }

       
        .help-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* ads */

        .text-box-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 300px;
            z-index: 11; /* Below modal but above other elements */
            pointer-events: none;
            gap: 220px;
        }

        .text-box {
            background-color: rgba(255, 255, 255, 0.8);
            border: 2px solid #2970db;
            border-radius: 8px;
            padding: 10px;
            width: 150px;
            text-align: center;
            font-weight: bold;
            color: #2970db;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            pointer-events: auto; /* Allow interaction */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .text-box:hover {
            background-color: #2970db;
            color: white;
            transform: scale(1.05);
        }

        #wheel-image-1, #wheel-image-2, #wheel-image-3, #wheel-image-4 {
    transition: opacity 0.3s ease-in-out;
    opacity: 0;
    visibility: hidden;
    position: absolute;
    width: 700px;
    height: auto;
    z-index: 5;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    pointer-events: none;
}

/* Desktop positioning (default) */
#wheel-image-1 {
    top: 5%;
    left: 25%;
}
#wheel-image-2 {
    top: 5%;
    right: 25%;
}
#wheel-image-3 {
    bottom: 5%;
    left: 25%;
}
#wheel-image-4 {
    bottom: 5%;
    right: 25%;
}

/* Mobile and tablet positioning */
@media (max-width: 768px) {
    #wheel-image-1, #wheel-image-2, #wheel-image-3, #wheel-image-4 {
        width: 700px;
        position: absolute;
    }

    #wheel-image-1 {
        top: 5%;
        left: 15%;
    }
    #wheel-image-2 {
        top: 5%;
        right: 15%;
    }
    #wheel-image-3 {
        bottom: 5%;
        left: 10%;
    }
    #wheel-image-4 {
        bottom: 5%;
        right: 10%;
    }
}

       
        /* Responsive Adjustments */
        @media (max-width: 480px) {
            .wheel-container {
                transform: scale(0.52);
            }
            #wheel-toggle {
                top: 10px;
                right: 10px;
                padding: 12px 20px;
                font-size: 14px;
                min-width: 44px;
                min-height: 44px;
            }
           /* .section-label {
          /      font-size: 21px !important;
           /     padding: 8px;
            }*/

            .nested-modal-content {
        max-height: 80vh;
        width: 85%;
        padding: 15px;
            }

            .wheel-larger.section-label {
                font-size:29px ;
                padding: 8px;
            }
            .wheel-large.section-label {
                font-size:30px ;
                padding: 8px;
            }
            .wheel-small .section-label {
                font-size: 20px;
                padding: 8px;
            }
            .wheel-medium .section-label {
                font: 21px;
                padding: 8px;
            }

            .modal-content {
                width: 95% !important;
                max-width: 350px !important;
                padding: 25px;
            }
            .nested-modal-content {
                width: 95%;
                padding: 20px;
            }
            .modal-title {
                font-size: 20px;
            }
            .modal-body {
                font-size: 20px;
                white-space: pre-wrap !important;
            }
            .content-box {
                padding: 15px;
                min-height: 44px;
                white-space: pre-wrap !important;
            }
            #modal-content, #nested-modal-content {
                white-space: pre-wrap !important;
                word-wrap: break-word;
                word-break: keep-all;
            }

            .text-box-container {
                width: 200px; 
                gap: 120px; 
            }

            .text-box {
                width: 100px; 
                padding: 6px; 
                font-size: 14px; 
            }

         
      
        }
        
        @media (min-width: 481px) and (max-width: 768px) {
            .wheel-container {
                transform: scale(0.75);
            }
            #wheel-toggle {
                top: 15px;
                right: 15px;
                padding: 13px 22px;
                font-size: 15px;
            }
            .section-label {
                font-size: 16px !important;
            }
            .modal-content, .nested-modal-content {
                width: 90%;

            }

            .text-box-container {
                width: 250px; /* Slightly adjusted for tablets */
                gap: 150px;
            }

            .text-box {
                width: 120px;
                padding: 8px;
                font-size: 15px;
            }
        }
        
         /* Update the rotatable wheel container */
         .rotatable-wheel-container {
            position: absolute;
            width: 800px;
            height: 800px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10; /* Ensure it's on top */
            pointer-events: none; /* Allow clicks to pass through */
        }

        /* Update the rotatable wheel styles */
        .rotatable-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: absolute;
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none; /* Allow clicks to pass through */
        }

        /* Base wheel part styles */
        .wheel-part {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #babd34;
            transform-origin: center;
            pointer-events: auto; /* Allow dragging on the wheel part */
            backdrop-filter: brightness(1.1); /* Subtle effect on underlying wheels */
        }
        
        /* First wheel with standard cutout */
        #rotatable-wheel .wheel-part {
            clip-path: polygon(50% 50%, 100% 0%, 100% 100%, 0% 100%, 0% 0%, 50% 0%);
            transform: rotate(54deg); /* Start after the cutout */
        }
        
        /* Second wheel with larger cutout */
        #rotatable-wheel-2 .wheel-part {
            clip-path: polygon(50% 50%, 100% 0%, 100% 100%, 0% 100%, 0% 0%, 1% 0%);
            transform: rotate(54deg); /* Start after the cutout */
        }

        .rotatable-wheel.active {
            cursor: grabbing;
        }

        /* Fraction styles */
/* Simple fraction styles */
/* Simple fraction styles */
.fraction {
    display: inline-block;
    vertical-align: middle;
    margin: 0 3px;
    text-align: center;
}
.fraction .numerator, .fraction .denominator {
    display: block;
    text-align: center;
}
.fraction .numerator {
    border-bottom: 1px solid #000;
    padding: 0 3px;
    margin-bottom: 1px;
}
.fraction .denominator {
    padding: 0 3px;
}
    </style>
</head>
<body>
<button id="theme-switcher">Change Theme</button>
    <button id="wheel-toggle" style="position: fixed; top: 20px; right: 20px; z-index: 1; padding: 15px 25px; background-color: #2970db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; min-width: 44px; min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent; transition: transform 0.2s ease, background-color 0.2s ease;">🔄</button>
    
    <div class="wheel-container" id="wheel-container-1" style="display: block;">
        <!-- Large wheel 8 sections -->
        <div class="wheel wheel-large" id="large-wheel"></div>
        
        <!-- Medium wheel 8 sections -->
        <div class="wheel wheel-medium" id="medium-wheel"></div>
        
        <!-- Small wheel 8 sections -->
        <div class="wheel wheel-small" id="small-wheel"></div>
        

        <!-- Larger wheel 4 sections -->
<div class="wheel wheel-larger" id="larger-wheel"></div>
        
        <!-- Rotatable wheel with cutout -->
        <div class="rotatable-wheel-container">
            <div class="rotatable-wheel" id="rotatable-wheel">
                <div class="wheel-part"></div>
                <div class="center"></div>
            </div>
        </div>
    </div>

    <div class="wheel-container" id="wheel-container-2" style="display: none;">
        <!-- Large wheel 8 sections -->
        <div class="wheel wheel-large" id="large-wheel-2" >
            
        </div>
        
        <!-- Image elements for wheel 2 container -->
        <img id="wheel-image-1" src="images/wheel-image1.png" alt="Wheel Image 1">
        <img id="wheel-image-2" src="images/wheel-image2.png" alt="Wheel Image 2">
        <img id="wheel-image-3" src="images/wheel-image3.png" alt="Wheel Image 3">
        <img id="wheel-image-4" src="images/wheel-image4.png" alt="Wheel Image 4">
    
        <!-- Larger wheel 4 sections -->
        <div class="wheel wheel-larger" id="larger-wheel-2"></div>
        
        <!-- Rotatable wheel with cutout -->
        <div class="rotatable-wheel-container">
            <div class="rotatable-wheel" id="rotatable-wheel-2">
                <div class="wheel-part"></div>
                <div class="center"></div>
            </div>
        </div>
    </div>

<canvas id="particle-canvas"></canvas>
    <div class="text-box-container" id="text-box-container">
        <div class="text-box" id="left-text-box">Nota 1</div>
        <div class="text-box" id="right-text-box">Nota 2</div>
    
</div>

    <!-- Modal Template -->
    <div id="section-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 class="modal-title" id="modal-title">Section Title</h2>
            <div class="modal-body" id="modal-body">
                <div id="modal-content"></div>
            </div>
        </div>
    </div>

    <!-- Nested Modal Template -->
    <div id="nested-modal" class="nested-modal">
        <div class="nested-modal-content">
            <span class="close-btn" onclick="closeNestedModal()">&times;</span>
            <h2 class="modal-title" id="nested-modal-title">Nested Modal Title</h2>
            <div class="modal-body">
                <div id="nested-modal-content" style="white-space: pre-line;"></div>
            </div>
        </div>
    </div>

    <script>
        // Prevent default touch behavior to avoid unwanted scrolling
        document.addEventListener('touchstart', function(e) {
            if (e.target.closest('.modal-content') || e.target.closest('.nested-modal-content')) {
                // Allow scrolling inside modals
                return;
            }
            if (e.target.id === 'wheel-toggle') {
                e.target.style.transform = 'scale(0.95)';
                e.target.style.backgroundColor = '#1e5bb0';
            }
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('touchend', function(e) {
            if (e.target.id === 'wheel-toggle') {
                e.target.style.transform = '';
                e.target.style.backgroundColor = '#2970db';
            }
        });

        document.addEventListener('touchmove', function(e) {
            if (e.target.closest('.modal-content') || e.target.closest('.nested-modal-content')) {
                // Allow scrolling inside modals
                return;
            }
            e.preventDefault();
        }, { passive: false });

        const fixads = {
            //dont remove
            "1": {
                a: `
Tulis semula atas,bawah (Selesaikan jika ada no)
Contoh :
 x⁴
──
y²
Jawapan :
 x⁴
──
y²

Contoh 2 : 
15x² 
──
-3y⁷   

Jawapan  : 
(15/-3)x² 
─
y⁷   
= 
-5x² 
─
y⁷ 
                `
            }
        };

        const fixads1 = {
            "1": {
                a: `
                <h3>Penjelasan</h3>
                Huruf tulis macam biasa
                (Selesaikan Pembahagian nombor kalau ada)

Contoh :
         35       
        ──                     
        y5        
              Jawapan :
               35 
               ──
               y5
                              
                           

Contoh 2 :
z9    
──              
4      
  Jawapan :
   z9
   ──
    4            


Contoh 3 :
  16z⁴                         
    ──   (16 bahagi 4) 
    4
            
                 Jawapan : 4z⁴
            `
            }
        };

        // Section content for the large wheel
        const sectionContent = {
            // Dont remove 
            "🔎¹": {
                title: "Huruf Darab Huruf",
                content: `
                    <h3>Pilih</h3>
                    <div class="content-box" data-title="Huruf Sama" data-content="<h2>Tambah kuasa</h2>
                    Contoh : X² x X⁵  
                    Jawapan : X²⁺⁵ 
                    = X⁸

                    Contoh 2 : -5y⁵ x 2y⁶ 
                    Jawapan = (-5 x 2)y⁵⁺⁶ 
                    = 10y⁹
                    ">Huruf Sama</div>

                    <div class="content-box" data-title="Huruf Tak Sama" data-content="Letak sebelah-sebelah
                    Contoh : a⁷ x b¹¹ 
                    Jawapan : a⁷b¹¹

                    Contoh 2 : 4a² x 6b⁵
                    Jawapan : (4x6)a²b⁵  
                    = 24a²b⁵
                    
                    ">Huruf Tak Sama</div>
                `
            },
            "🔎²": {
                title: "Huruf darab no, No darab huruf",
                content: `
                <h3>Penjelasan</h3>
                        Tulis nombor atau hasil darab nombor diikuti huruf

                        Contoh : -3 x y²
                        Jawapan : -3y²

                        Contoh 2 : 3 x 2x⁵
                        Jawapan : 6x⁵
                
                `
            },
            "🔎³": {
                title: "Huruf Bahagi Huruf",
                content: `
                    <h3>Pilih</h3>
                    <div class="content-box" data-title="Huruf Sama" data-content="
                    Tolak kuasa 
                    Contoh : m⁸ ÷ m⁵
                    Jawapan : m⁸⁻⁵ = m³

                    Contoh 2: 12p⁷ ÷ 3p²
                            
                    Jawapan : (12÷3)p⁷-²
                            =4p³
                    
                    
                    .">Huruf Bahagi Huruf</div>
                    <div class="content-box" data-title="Huruf tak sama" data-content-ref="fixads-1">Huruf tak sama</div>
                `
            },
            "🔎⁴": {
                title: "Huruf Bahagi no, No bahagi huruf",
                content: `
                <div class="content-box" data-title="Huruf Bahagi Huruf" data-content-ref="fixads1-1">Huruf Bahagi Huruf</div>
                `
            },
            "🔎⁵": {
                title: "Sebutan Serupa",
                content: `
                    <h3>Penjelasan</h3>Jumlahkan nombor diikuti huruf.
                    (TEKAN KALKULATOR)
                  Contoh : 3x + 5x
                  Jawapan : 8x
                         
                         
                `
            },
            "🔎⁶": {
                title: "Sebutan Tak Serupa",
                content: `
                    <h3>Penjelasan</h3>
                    Salin balik soalan yang diberikan
                    Contoh : 8x + 5y
                    Jawapan : 8x + 5y
                `
            },
            "🔎⁷": {
                title: "Sebutan Tak Serupa",
                content: `
                     <h3>Penjelasan</h3>
                  Tolakkan nombor diikuti huruf
                  (TEKAN KALKULATOR)
                  
                  Contoh : 12x - 7x
                  Jawapan : 5x
                `
            },
            "🔎⁸": {
                title: "Sebutan Tak Serupa",
                content: `
                    <h3>Penjelasan</h3>
                    Salin balik soalan yang diberikan
                    Contoh : 12x - x²
                    Jawapan : 12x - x²
                `
            },
        };

        // Improved processFractions function that preserves characters next to the fraction line
        function processFractions(content) {
            // Safety check
            if (!content || typeof content !== 'string') {
                return content;
            }
            
            // If no fraction character, return content as is
            if (!content.includes('─')) {
                return content;
            }
            
            // For multi-line fractions with possible characters next to the line
            let result = content.replace(/([^\n]+)\n([^─\n]*)(─+)([^\n]*)\n([^\n]+)/g, function(match, numerator, beforeLine, line, afterLine, denominator) {
                // Clean up the numerator and denominator
                const cleanNumerator = numerator.trim();
                const cleanDenominator = denominator.trim();
                
                // Preserve characters before and after the fraction line
                const beforeText = beforeLine ? beforeLine.trim() : '';
                const afterText = afterLine ? afterLine.trim() : '';
                
                // Create the fraction HTML with preserved characters
                return `${beforeText}<div class="fraction"><span class="numerator">${cleanNumerator}</span><span class="denominator">${cleanDenominator}</span></div>${afterText}`;
            });
            
            // For inline fractions with possible characters next to the line
            result = result.replace(/(\S+)\s*([^─\s]*)(─+)([^─\s]*)\s*(\S+)/g, function(match, numerator, beforeLine, line, afterLine, denominator) {
                // Preserve characters before and after the fraction line
                const beforeText = beforeLine ? beforeLine : '';
                const afterText = afterLine ? afterLine : '';
                
                // Create the fraction HTML with preserved characters
                return `${beforeText}<div class="fraction"><span class="numerator">${numerator}</span><span class="denominator">${denominator}</span></div>${afterText}`;
            });
            
            return result;
        }

        // Updated openModal function
        function openModal(sectionName, customContent = null) {
            const modal = document.getElementById('section-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            
            // Get the section content from the sectionContent object
            const section = sectionContent[sectionName] || {
                title: sectionName,
                content: `<p>Content for ${sectionName} will be available soon.</p>`
            };

            // Clear previous content
            modalContent.innerHTML = '';

            // Set modal title
            modalTitle.textContent = section.title;

            // Add custom content if provided
            if (customContent) {
                const contentDiv = document.createElement('div');
                contentDiv.style.whiteSpace = 'pre-wrap';
                contentDiv.style.wordBreak = 'keep-all';
                contentDiv.style.textAlign = 'left';
                
                // Process content for fractions - ensure customContent is a string
                customContent = customContent || "";
                
                // Check for fractions and process them
                let processedContent = customContent;
                if (customContent.includes('─')) {
                    try {
                        processedContent = processFractions(customContent);
                    } catch (e) {
                        console.error("Error processing fractions:", e);
                    }
                }
                
                // Add line breaks after processing fractions
                processedContent = processedContent.replace(/\n/g, '<br>');
                
                contentDiv.innerHTML = processedContent;
                modalContent.appendChild(contentDiv);
            } else {
                // Just use the existing content directly if it's already HTML
                if (typeof section.content === 'string' && section.content.trim().startsWith('<')) {
                    modalContent.innerHTML = section.content;
                } else {
                    // Process as regular content with possible fractions
                    const contentDiv = document.createElement('div');
                    contentDiv.style.whiteSpace = 'pre-wrap';
                    contentDiv.style.wordBreak = 'keep-all';
                    contentDiv.style.textAlign = 'left';
                    
                    // Ensure section.content is a string
                    const sectionContent = section.content || "";
                    
                    // Check for fractions and process them
                    let processedContent = sectionContent;
                    if (sectionContent.includes('─')) {
                        try {
                            processedContent = processFractions(sectionContent);
                        } catch (e) {
                            console.error("Error processing fractions:", e);
                        }
                    }
                    
                    // Add line breaks after processing fractions
                    processedContent = processedContent.replace(/\n/g, '<br>');
                    
                    contentDiv.innerHTML = processedContent;
                    modalContent.appendChild(contentDiv);
                }
            }

            modal.style.display = 'block';
        }
        
        // Updated openNestedModal function to fix whitespace and add scrolling
        function openNestedModal(title, content) {
            document.getElementById('nested-modal-title').textContent = title;
            
            // Get the nested modal content element
            const nestedModalContent = document.getElementById('nested-modal-content');
            
            // Process fractions in the content if needed
            let processedContent = content;
            if (content.includes('─')) {
                processedContent = processFractions(content);
            }
            
            // Fix spacing issues by replacing consecutive spaces and newlines with a single space
            processedContent = processedContent.replace(/\s+/g, ' ');
            
            // Explicitly add line breaks for proper formatting
            processedContent = processedContent
                .replace(/Penjelasan/g, '<br><strong>Penjelasan</strong>')
                .replace(/Contoh :/g, '<br><br><strong>Contoh :</strong>')
                .replace(/Contoh 2 :/g, '<br><br><strong>Contoh 2 :</strong>')
                .replace(/Contoh 3 :/g, '<br><br><strong>Contoh 3 :</strong>')
                .replace(/Jawapan :/g, '<br><strong>Jawapan :</strong>');
            
            // Set the content with the processed text
            nestedModalContent.innerHTML = processedContent;
            
            // Make sure scrolling is enabled
            document.querySelector('.nested-modal-content').style.overflow = 'auto';
            
            // Show the modal
            document.getElementById('nested-modal').style.display = 'block';
        }

        function closeNestedModal() {
            document.getElementById('nested-modal').style.display = 'none';
        }

        // *** NEW CONTENT BOX HANDLER FOR MOBILE COMPATIBILITY ***
        // This replaces the onclick attributes with event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners for content boxes
            setupContentBoxes();
            
            // Set up close button handlers
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    let modal = this.closest('.modal, .nested-modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                });
                
                btn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    let modal = this.closest('.modal, .nested-modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }, { passive: false });
            });
            
            // Specific nested modal close handler
            document.querySelector('#nested-modal .close-btn').addEventListener('click', closeNestedModal);
            document.querySelector('#nested-modal .close-btn').addEventListener('touchend', function(e) {
                e.preventDefault();
                closeNestedModal();
            }, { passive: false });
        });
        
        // New function to set up content box event listeners
        function setupContentBoxes() {
            // Wait for content boxes to be in the DOM
            setTimeout(function() {
                document.querySelectorAll('.content-box').forEach(box => {
                    // Handle click
                    box.addEventListener('click', handleContentBoxClick);
                    
                    // Handle touch separately for mobile
                    box.addEventListener('touchend', function(e) {
                        e.preventDefault();
                        handleContentBoxClick.call(this, e);
                    }, { passive: false });
                });
            }, 100);
        }
        
        // Handler function for content box clicks and touches
        function handleContentBoxClick(e) {
    let title = this.getAttribute('data-title');
    let content = this.getAttribute('data-content');
    let contentRef = this.getAttribute('data-content-ref');
    
    // If we have a content reference instead of direct content
    if (contentRef) {
        // Parse the content reference format (e.g., "fixads-1")
        const parts = contentRef.split('-');
        if (parts.length === 2) {
            const objName = parts[0];
            const key = parts[1];
            
            // Check each possible reference object
            if (objName === 'fixads' && fixads[key] && fixads[key].a) {
                content = fixads[key].a;
            } else if (objName === 'fixads1' && fixads[key] && fixads1[key].a) {
                content = fixads1[key].a;
            }
        }
    }
    
    if (title && (content || contentRef)) {
        openNestedModal(title, content);
    } else {
        console.error("Missing content for modal", title, contentRef);
    }
}

// Separate function for touch end to make sure preventDefault is called
function handleContentBoxTouchEnd(e) {
    e.preventDefault();
    e.stopPropagation();
    handleContentBoxClick.call(this, e);
}

// Update setupContentBoxes function to properly set up content boxes
function setupContentBoxes() {
    // Process all content boxes in the DOM
    document.querySelectorAll('.content-box').forEach(box => {
        // Remove any existing event listeners (to prevent duplicates)
        box.removeEventListener('click', handleContentBoxClick);
        box.removeEventListener('touchend', handleContentBoxTouchEnd);
        
        // Add click event
        box.addEventListener('click', handleContentBoxClick);
        
        // Add touch event with passive:false
        box.addEventListener('touchend', handleContentBoxTouchEnd, { passive: false });
        
        // If there's an onclick attribute but no data attributes, extract them
        const onclickAttr = box.getAttribute('onclick');
        if (onclickAttr && onclickAttr.includes('openNestedModal')) {
            if (!box.hasAttribute('data-title') || (!box.hasAttribute('data-content') && !box.hasAttribute('data-content-ref'))) {
                try {
                    // Extract parameters from the onclick attribute
                    const match = onclickAttr.match(/openNestedModal\(['"]([^'"]+)['"],\s*(['"])([^'"]+)(['"])\)/);
                    if (match && match.length >= 5) {
                        const title = match[1];
                        const content = match[3];
                        
                        // Set data attributes and remove onclick
                        box.setAttribute('data-title', title);
                        
                        // Check if content is a reference to fixads or fixads1
                        if (content.trim() === 'fixads[1].a') {
                            box.setAttribute('data-content-ref', 'fixads-1');
                        } else if (content.trim() === 'fixads1[1].a') {
                            box.setAttribute('data-content-ref', 'fixads1-1');
                        } else {
                            box.setAttribute('data-content', content);
                        }
                        
                        // Remove the onclick attribute to avoid conflicts
                        box.removeAttribute('onclick');
                    }
                } catch (e) {
                    console.error("Error parsing onclick:", e);
                }
            }
        }
    });
}

// Modified MutationObserver setup
function setupObservers() {
    // Observer for modal content
    const modalContentObserver = new MutationObserver(function(mutations) {
        let shouldSetup = false;
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                // Check if any added nodes contain content boxes
                mutation.addedNodes.forEach(node => {
                    if (node.nodeType === 1) { // Element node
                        if (node.classList && node.classList.contains('content-box')) {
                            shouldSetup = true;
                        } else if (node.querySelectorAll) {
                            const boxes = node.querySelectorAll('.content-box');
                            if (boxes.length > 0) shouldSetup = true;
                        }
                    }
                });
            }
        });
        
        if (shouldSetup) {
            // Small delay to ensure DOM is updated
            setTimeout(setupContentBoxes, 50);
        }
    });
    
    // Start observing modal content
    const modalContent = document.getElementById('modal-content');
    if (modalContent) {
        modalContentObserver.observe(modalContent, {
            childList: true,
            subtree: true
        });
    }
    
    // Also observe the section modal itself in case content is added directly
    const sectionModal = document.getElementById('section-modal');
    if (sectionModal) {
        modalContentObserver.observe(sectionModal, {
            childList: true,
            subtree: true
        });
    }
}

// Initialize observers and setup content boxes
document.addEventListener('DOMContentLoaded', function() {
    setupObservers();
    setupContentBoxes();
    
    // Force setup after a short delay to catch any boxes added during initial rendering
    setTimeout(setupContentBoxes, 500);
});

// Close modals when clicking or tapping outside
window.addEventListener('click', function(event) {
    let nestedModal = document.getElementById('nested-modal');
    let sectionModal = document.getElementById('section-modal');
    
    if (event.target == nestedModal) {
        nestedModal.style.display = 'none';
    } else if (event.target == sectionModal) {
        sectionModal.style.display = 'none';
    }
});

window.addEventListener('touchend', function(event) {
    let nestedModal = document.getElementById('nested-modal');
    let sectionModal = document.getElementById('section-modal');
    
    if (event.target == nestedModal) {
        nestedModal.style.display = 'none';
    } else if (event.target == sectionModal) {
        sectionModal.style.display = 'none';
    }
});
        
        // The rest of the JavaScript remains the same
        
        // Create wheel sections function
        function createWheelSections(wheelId, numSections, radius, labels, fontSize, labelRadiusPercent) {
            // Your existing function remains unchanged
            const wheel = document.getElementById(wheelId);
            const angleStep = 360 / numSections;
            const isSecondLargerWheel = wheelId === 'larger-wheel-2';
            
            for (let i = 0; i < numSections; i++) {
                // Create divider
                const divider = document.createElement('div');
                divider.className = 'section-divider';
                divider.style.width = radius + 'px';
                divider.style.transform = `rotate(${i * angleStep}deg)`;
                wheel.appendChild(divider);
                
                // Calculate label position
                const labelAngle = (i * angleStep) + (angleStep / 2);
                const labelRadius = radius * labelRadiusPercent;
                const labelRadian = (labelAngle * Math.PI) / 180;
                const x = 50 + (Math.cos(labelRadian) * labelRadius / (radius * 2) * 100);
                const y = 50 + (Math.sin(labelRadian) * labelRadius / (radius * 2) * 100);
                
                // Create the label
                const label = document.createElement('div');
                label.className = 'section-label';
                const labelText = labels[i % labels.length];
                
                // Special handling for larger-wheel-2 to create circular text
                if (isSecondLargerWheel) {
                    // Create a container for the circular text
                    label.style.position = 'absolute';
                    label.style.left = '50%';
                    label.style.top = '49.5%';
                    label.style.transform = 'translate(-50%, -50%)';
                    label.style.width = `${radius * 2}px`;
                    label.style.height = `${radius * 2}px`;
                    label.style.pointerEvents = 'none'; // Prevent interference with clicks
                   
                    
                    // Create individual characters and position them in a circle
                    const chars = labelText.split('');
                    
                    // Calculate an appropriate arc angle based on text length
                    const arcAngle = Math.min(70, 15 + (chars.length * 2.5)); // Wider arc for better readability
                    
                    // Position the text centered on the section
                    const startAngle = labelAngle - (arcAngle / 2) - 90; // Center the text on the section
                    
                    // Adjust radius for text placement - slightly larger than the wheel radius for better positioning
                    const textRadius = labelRadius * 1.02;
                    
                    chars.forEach((char, index) => {
                        if (char === ' ') return; // Skip spaces to avoid empty spans
                        
                        const charSpan = document.createElement('span');
                        charSpan.textContent = char;
                        charSpan.style.position = 'absolute';
                        charSpan.style.fontSize = `${fontSize}px`;
                        charSpan.style.color = 'black';
                        charSpan.style.fontWeight = 'bold';
                        // Removed text shadow to eliminate white stroke effect
                        
                        // Calculate position along the arc - distribute characters evenly
                        const charAngle = startAngle + (index * (arcAngle / (chars.length - 1 || 1)));
                        const charRadian = (charAngle * Math.PI) / 180;
                        
                        // Calculate position with adjusted radius
                        const charX = 50 + (Math.cos(charRadian) * textRadius / (radius * 2) * 100);
                        const charY = 50 + (Math.sin(charRadian) * textRadius / (radius * 2) * 100);
                        
                        charSpan.style.left = `${charX}%`;
                        charSpan.style.top = `${charY}%`;
                        
                        // Rotate each character to follow the circle tangent
                        charSpan.style.transform = `translate(-50%, -50%) rotate(${charAngle + 90}deg)`;
                        
                        label.appendChild(charSpan);
                    });
                    
                    // Add pointer events to the entire label for better interaction
                    label.style.pointerEvents = 'auto';
                }
                 else {
                    // Standard text handling for other wheels
                    const words = labelText.split(' ');
                    label.textContent = words.length > 3 ? words.slice(0, 3).join(' ') + '\n' + words.slice(3).join(' ') : labelText;
                    label.style.whiteSpace = 'pre-line';
                    label.style.left = `${x}%`;
                    label.style.top = `${y}%`;
                    label.style.fontSize = `${fontSize}px`;
                    
                    // Make text clickable for large wheel
                    if (wheelId === 'large-wheel') {
                        label.className += ' clickable-label';
                        label.id = `section-${i+1}-label-${wheelId}`;
                        label.setAttribute('data-section', labelText);
                        
                        // Add both click and touch events
                        label.addEventListener('click', function() {
                            openModal(labelText);
                        });
                        
                        label.addEventListener('touchend', function(e) {
                            e.preventDefault();
                            openModal(labelText);
                        }, { passive: false });
                    }
                }
                
                wheel.appendChild(label);
            }
        }
        
        // Modal functions
         // Modify content box to preserve whitespace when opened
         

         // Fixed processFractions function that handles all types of fractions correctly
        // Improved processFractions function that correctly handles fractions
// Improved processFractions function that preserves characters next to the fraction line
function processFractions(content) {
    // Safety check
    if (!content || typeof content !== 'string') {
        return content;
    }
    
    // If no fraction character, return content as is
    if (!content.includes('─')) {
        return content;
    }
    
    // For multi-line fractions with possible characters next to the line
    let result = content.replace(/([^\n]+)\n([^─\n]*)(─+)([^\n]*)\n([^\n]+)/g, function(match, numerator, beforeLine, line, afterLine, denominator) {
        // Clean up the numerator and denominator
        const cleanNumerator = numerator.trim();
        const cleanDenominator = denominator.trim();
        
        // Preserve characters before and after the fraction line
        const beforeText = beforeLine ? beforeLine.trim() : '';
        const afterText = afterLine ? afterLine.trim() : '';
        
        // Create the fraction HTML with preserved characters
        return `${beforeText}<div class="fraction"><span class="numerator">${cleanNumerator}</span><span class="denominator">${cleanDenominator}</span></div>${afterText}`;
    });
    
    // For inline fractions with possible characters next to the line
    result = result.replace(/(\S+)\s*([^─\s]*)(─+)([^─\s]*)\s*(\S+)/g, function(match, numerator, beforeLine, line, afterLine, denominator) {
        // Preserve characters before and after the fraction line
        const beforeText = beforeLine ? beforeLine : '';
        const afterText = afterLine ? afterLine : '';
        
        // Create the fraction HTML with preserved characters
        return `${beforeText}<div class="fraction"><span class="numerator">${numerator}</span><span class="denominator">${denominator}</span></div>${afterText}`;
    });
    
    return result;
}





// Update the openModal function as well
// Update the openModal function
// Updated openModal function
// Updated openModal function
function openModal(sectionName, customContent = null) {
    const modal = document.getElementById('section-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    
    // Get the section content from the sectionContent object
    const section = sectionContent[sectionName] || {
        title: sectionName,
        content: `<p>Content for ${sectionName} will be available soon.</p>`
    };

    // Clear previous content
    modalContent.innerHTML = '';

    // Set modal title
    modalTitle.textContent = section.title;

    // Add custom content if provided
    if (customContent) {
        const contentDiv = document.createElement('div');
        contentDiv.style.whiteSpace = 'pre-wrap';
        contentDiv.style.wordBreak = 'keep-all';
        contentDiv.style.textAlign = 'left';
        
        // Process content for fractions - ensure customContent is a string
        customContent = customContent || "";
        
        // Check for fractions and process them
        let processedContent = customContent;
        if (customContent.includes('─')) {
            try {
                processedContent = processFractions(customContent);
            } catch (e) {
                console.error("Error processing fractions:", e);
            }
        }
        
        // Add line breaks after processing fractions
        processedContent = processedContent.replace(/\n/g, '<br>');
        
        contentDiv.innerHTML = processedContent;
        modalContent.appendChild(contentDiv);
    } else {
        // Just use the existing content directly if it's already HTML
        if (typeof section.content === 'string' && section.content.trim().startsWith('<')) {
            modalContent.innerHTML = section.content;
        } else {
            // Process as regular content with possible fractions
            const contentDiv = document.createElement('div');
            contentDiv.style.whiteSpace = 'pre-wrap';
            contentDiv.style.wordBreak = 'keep-all';
            contentDiv.style.textAlign = 'left';
            
            // Ensure section.content is a string
            const sectionContent = section.content || "";
            
            // Check for fractions and process them
            let processedContent = sectionContent;
            if (sectionContent.includes('─')) {
                try {
                    processedContent = processFractions(sectionContent);
                } catch (e) {
                    console.error("Error processing fractions:", e);
                }
            }
            
            // Add line breaks after processing fractions
            processedContent = processedContent.replace(/\n/g, '<br>');
            
            contentDiv.innerHTML = processedContent;
            modalContent.appendChild(contentDiv);
        }
    }

    modal.style.display = 'block';
}
        
        // Open nested modal
        // Update the openNestedModal function
      // Fixed openNestedModal function that preserves fraction formatting
     // Updated openNestedModal function to fix whitespace and add scrolling
function openNestedModal(title, content) {
    document.getElementById('nested-modal-title').textContent = title;
    
    // Get the nested modal content element
    const nestedModalContent = document.getElementById('nested-modal-content');
    
    // Process fractions in the content if needed
    let processedContent = content;
    if (content.includes('─')) {
        processedContent = processFractions(content);
    }
    
    // Fix spacing issues by replacing consecutive spaces and newlines with a single space
    processedContent = processedContent.replace(/\s+/g, ' ');
    
    // Explicitly add line breaks for proper formatting
    processedContent = processedContent
        .replace(/Penjelasan/g, '<br><strong>Penjelasan</strong>')
        .replace(/Contoh :/g, '<br><br><strong>Contoh :</strong>')
        .replace(/Contoh 2 :/g, '<br><br><strong>Contoh 2 :</strong>')
        .replace(/Contoh 3 :/g, '<br><br><strong>Contoh 3 :</strong>')
        .replace(/Jawapan :/g, '<br><strong>Jawapan :</strong>');
    
    // Set the content with the processed text
    nestedModalContent.innerHTML = processedContent;
    
    // Make sure scrolling is enabled
    document.querySelector('.nested-modal-content').style.overflow = 'auto';
    
    // Show the modal
    document.getElementById('nested-modal').style.display = 'block';
}



// Make sure this function exists
function closeNestedModal() {
    document.getElementById('nested-modal').style.display = 'none';
}


// Add this event listener
document.addEventListener('DOMContentLoaded', function() {
    
    document.querySelector('#nested-modal .close-btn').addEventListener('click', closeNestedModal);
});





        
        // Close modal handlers
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                let modal = this.closest('.modal, .nested-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            });
        });
        
        // Close modals when clicking outside


        
        window.addEventListener('click', function(event) {
            let nestedModal = document.getElementById('nested-modal');
            let sectionModal = document.getElementById('section-modal');
            
            if (event.target == nestedModal) {
                nestedModal.style.display = 'none';
            } else if (event.target == sectionModal) {
                sectionModal.style.display = 'none';
            }
        });
        
        // Close modals when tapping outside on mobile
        window.addEventListener('touchend', function(event) {
            let nestedModal = document.getElementById('nested-modal');
            let sectionModal = document.getElementById('section-modal');
            
            if (event.target == nestedModal) {
                nestedModal.style.display = 'none';
            } else if (event.target == sectionModal) {
                sectionModal.style.display = 'none';
            }
        });
        
        // Rotatable wheel functionality for both wheels
const rotatableWheel1 = document.getElementById('rotatable-wheel');
const rotatableWheel2 = document.getElementById('rotatable-wheel-2');

const wheelParts = document.querySelectorAll('.wheel-part');
let isDragging = false;
let startAngle = 0;
let currentRotation1 = 90;
let currentRotation2 = 90;
        
       

        // Apply initial rotation to both wheels
wheelParts[0].style.transform = `rotate(${currentRotation1}deg)`;
wheelParts[1].style.transform = `rotate(${currentRotation2}deg)`;
        
        // Function to handle both mouse and touch events for rotatable wheel
        function handleStart(e) {
            const wheelPart = e.target.closest('.wheel-part');
            if (!wheelPart) return;
            
            isDragging = true;
            const rotatableWheel = wheelPart.closest('.rotatable-wheel');
            rotatableWheel.classList.add('active');
            
            // Get the center of the wheel
            const rect = rotatableWheel.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // Get starting position (mouse or touch)
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            
            // Calculate starting angle
            startAngle = Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;
            
            // Prevent default behavior to avoid scrolling on mobile
            e.preventDefault();
        }
        
        function handleMove(e) {
            if (!isDragging) return;
            
            const wheelPart = document.querySelector('.wheel-part:hover') || document.elementFromPoint(e.clientX || e.touches[0].clientX, e.clientY || e.touches[0].clientY).closest('.wheel-part');
            if (!wheelPart) return;
            
            const rotatableWheel = wheelPart.closest('.rotatable-wheel');
            const isWheel1 = rotatableWheel.id === 'rotatable-wheel';
            
            // Get the center of the wheel
            const rect = rotatableWheel.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // Get current position (mouse or touch)
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            
            // Calculate current angle
            const angle = Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;
            
            // Calculate rotation
            const rotation = angle - startAngle;
            
            // Update current rotation for the active wheel
            if (isWheel1) {
                currentRotation1 = (currentRotation1 + rotation) % 360;
                wheelPart.style.transform = `rotate(${currentRotation1}deg)`;
            } else {
                currentRotation2 = (currentRotation2 + rotation) % 360;
                wheelPart.style.transform = `rotate(${currentRotation2}deg)`;
            }
            
            // Rotate text box container to match wheel rotation (REVERSED)
            const textBoxContainer = document.getElementById('text-box-container');
            const activeWheel = document.getElementById('wheel-container-1').style.display === 'block' ? 1 : 2;
            const currentRotationValue = activeWheel === 1 ? currentRotation1 : currentRotation2;
            textBoxContainer.style.transform = `translate(-50%, -50%) rotate(${currentRotationValue * 0.9 - 65}deg)`;
            
            // Reset start angle for next move
            startAngle = angle;
            
            // Prevent default behavior to avoid scrolling on mobile
            e.preventDefault();
        }

        // Add event listeners for text boxes
        document.addEventListener('DOMContentLoaded', function() {
            const leftTextBox = document.getElementById('left-text-box');
            const rightTextBox = document.getElementById('right-text-box');

            // Example interaction
            leftTextBox.addEventListener('click', function() {
                openModal('Left Box', '<p>This is the content for the left text box.</p>');
            });

            rightTextBox.addEventListener('click', function() {
                openModal('Right Box', '<p>This is the content for the right text box.</p>');
            });
        });

        function handleEnd() {
            if (!isDragging) return;
            isDragging = false;
            rotatableWheel.classList.remove('active');
        }
        /*ads*/
      document.addEventListener('DOMContentLoaded', function() {
            const leftTextBox = document.getElementById('left-text-box');
            const rightTextBox = document.getElementById('right-text-box');

            // Content for text boxes
            // Content for text boxes
const content1 = {
    "1": {
        a: `

          Sebutan Serupa
     - Huruf sama
     - Kuasa pada huruf sama  


        Contoh :

                          4        
    2x,-3x² , -5x³, -8x,  ─   x                                             
                           3                             

            Sebutan Serupa :
            
         4
2x,-8x,  ─  x
         3
                `
    },
    "2": {
        b: `
Untuk x/÷ ⮕ Gabungan nombor dan huruf  x/÷
              gabungan nombor dan huruf
            
         ⮕ Nombor darab atau bahagi macam biasa, huruf-rujuk bahagian huruf x/÷
                `
    }
};

            // Enhanced touch and click handling
            function addTouchHandler(element, content, title) {
                // Add click event
                element.addEventListener('click', function() {
                    openModal(title, content);
                });

                // Add touch event
                element.addEventListener('touchstart', function(e) {
                    e.preventDefault(); // Prevent default touch behavior
                    openModal(title, content);
                }, { passive: false });
            }

            // Apply touch and click handlers
            addTouchHandler(leftTextBox, content1["1"].a, 'Nota 1');
            addTouchHandler(rightTextBox, content1["2"].b, 'Nota 2');
        });


        // Add mouse event listeners for rotatable wheel
        document.addEventListener('mousedown', handleStart);
        document.addEventListener('mousemove', handleMove);
        document.addEventListener('mouseup', handleEnd);
        
        // Add touch event listeners for rotatable wheel on mobile
        document.addEventListener('touchstart', handleStart, { passive: false });
        document.addEventListener('touchmove', handleMove, { passive: false });
        document.addEventListener('touchend', handleEnd);
        
        // Define wheel data for first set
        const largerWheelLabels = ['x', '÷', '+', '-'];
        const smallWheelLabels = ['x', 'x', '÷', '÷', '+', '+', '-', '-'];
        const mediumWheelLabels = ['Huruf Darab Huruf', 'Huruf Darab No, No Darab Huruf', 'Huruf Bahagi Huruf', 'Huruf bahagi no, no Bahagi Huruf', 'Sebutan Serupa', 'Sebutan Tak Serupa', 'Sebutan Serupa', 'Sebutan Tak Serupa'];
        const largeWheelLabels = ['🔎¹', '🔎²', '🔎³', '🔎⁴', '🔎⁵', '🔎⁶', '🔎⁷', '🔎⁸'];

        // Define wheel data for second set
        const largerWheelLabels2 = ['Ketumpatan / Density', 'Kuasa / Power', 'Tenaga / Energy', 'Ohm Law / Hukum Ohm'];
        const largeWheelLabels2 = ['‎', '‎', '‎', '‎'];
        
        // CSS for circular text
        const circularTextStyle = document.createElement('style');
        circularTextStyle.textContent = `
            .circular-text {
                position: absolute;
                height: 100%;
                width: 100%;
                transform-origin: center;
                text-align: center;
            }
            
            .circular-text span {
                position: absolute;
                left: 50%;
                transform-origin: 0 450px; /* Match the radius of larger wheel */
                font-weight: bold;
            }
        `;
        document.head.appendChild(circularTextStyle);
        
        
        
        // Create the wheels
        window.addEventListener('DOMContentLoaded', function() {
            // Initialize first wheel set
            createWheelSections('larger-wheel', 4, 450, largerWheelLabels, 34, 0.93);
            createWheelSections('small-wheel', 8, 100, smallWheelLabels, 47, 0.6);
            createWheelSections('medium-wheel', 8, 250, mediumWheelLabels, 16, 0.79);
            createWheelSections('large-wheel', 8, 400, largeWheelLabels, 44, 0.8);

            // Initialize second wheel set with different labels
            createWheelSections('larger-wheel-2', 4, 450, largerWheelLabels2, 20, 0.93);
            
            createWheelSections('large-wheel-2', 4, 400, largeWheelLabels2, 44, 0.6);

            // Add wheel toggle functionality
            const wheelToggle = document.getElementById('wheel-toggle');
            const wheelContainer1 = document.getElementById('wheel-container-1');
            const wheelContainer2 = document.getElementById('wheel-container-2');
            
            // Function to update wheel images visibility
            function updateWheelImages(showWheel2) {
                const wheelImages = [
                    document.getElementById('wheel-image-1'),
                    document.getElementById('wheel-image-2'),
                    document.getElementById('wheel-image-3'),
                    document.getElementById('wheel-image-4')
                ];
                
                wheelImages.forEach(img => {
                    if (showWheel2) {
                        // Show images when wheel 2 is visible
                        img.style.opacity = '1';
                        img.style.visibility = 'visible';
                    } else {
                        // Hide images when wheel 1 is visible
                        img.style.opacity = '0';
                        img.style.visibility = 'hidden';
                    }
                });
            }

            wheelToggle.addEventListener('click', function() {
                const isWheel1Visible = wheelContainer1.style.display === 'block';
                
                // Add hidden class first to trigger fade out
                if (isWheel1Visible) {
                    wheelContainer1.classList.add('hidden');
                } else {
                    wheelContainer2.classList.add('hidden');
                }
                
                // Wait for fade out animation to complete
                setTimeout(() => {
                    wheelContainer1.style.display = isWheel1Visible ? 'none' : 'block';
                    wheelContainer2.style.display = isWheel1Visible ? 'block' : 'none';
                    
                    // Update image visibility
                    updateWheelImages(isWheel1Visible);
                    
                    // Remove hidden class to trigger fade in
                    if (isWheel1Visible) {
                        wheelContainer2.classList.remove('hidden');
                    } else {
                        wheelContainer1.classList.remove('hidden');
                    }
                    
                    // Toggle text box container visibility
                    const textBoxContainer = document.querySelector('.text-box-container');
                    textBoxContainer.style.display = isWheel1Visible ? 'none' : 'flex';
                }, 300); // Match the transition duration
            });

            wheelToggle.addEventListener('touchend', function(e) {
                e.preventDefault();
                const isWheel1Visible = wheelContainer1.style.display === 'block';
                
                // Add hidden class first to trigger fade out
                if (isWheel1Visible) {
                    wheelContainer1.classList.add('hidden');
                } else {
                    wheelContainer2.classList.add('hidden');
                }
                
                // Wait for fade out animation to complete
                setTimeout(() => {
                    wheelContainer1.style.display = isWheel1Visible ? 'none' : 'block';
                    wheelContainer2.style.display = isWheel1Visible ? 'block' : 'none';
                    
                    // Update image visibility for mobile
                    updateWheelImages(isWheel1Visible);
                    
                    // Remove hidden class to trigger fade in
                    if (isWheel1Visible) {
                        wheelContainer2.classList.remove('hidden');
                    } else {
                        wheelContainer1.classList.remove('hidden');
                    }
                    
                    // Toggle text box container visibility
                    const textBoxContainer = document.querySelector('.text-box-container');
                    textBoxContainer.style.display = isWheel1Visible ? 'none' : 'flex';
                }, 300); // Match the transition duration
            }, { passive: false });
           
            
            // Add extra touch zone for better touch detection on mobile
            const largeWheel = document.getElementById('large-wheel');
            
            largeWheel.addEventListener('touchstart', function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                handleTouchInteraction(touch.clientX, touch.clientY);
            }, { passive: false });
            
            function handleTouchInteraction(x, y) {
                const element = document.elementFromPoint(x, y);
                if (element && element.classList.contains('clickable-label')) {
                    const sectionName = element.getAttribute('data-section');
                    if (sectionName) {
                        openModal(sectionName);
                    }
                }
            }
        });
        
        // Handle orientation changes for better mobile experience
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                const container1 = document.getElementById('wheel-container-1');
                const container2 = document.getElementById('wheel-container-2');
                const rotatableContainers = document.querySelectorAll('.rotatable-wheel-container');
                
                if (window.innerHeight > window.innerWidth) {
                    // Portrait mode
                    container1.style.transform = 'translate(-50%, -50%) scale(0.6)';
                    container2.style.transform = 'translate(-50%, -50%) scale(0.6)';
                    rotatableContainers.forEach(container => {
                        container.style.transform = 'translate(-50%, -50%) scale(0.6)';
                    });
                } else {
                    // Landscape mode
                    container1.style.transform = 'translate(-50%, -50%) scale(0.8)';
                    container2.style.transform = 'translate(-50%, -50%) scale(0.8)';
                    rotatableContainers.forEach(container => {
                        container.style.transform = 'translate(-50%, -50%) scale(0.8)';
                    });
                }
            }, 200);
        });

        // Add event delegation for content boxes
// Add event delegation for content boxes
// Add event delegation for content boxes
document.addEventListener('click', function(e) {
    const contentBox = e.target.closest('.content-box');
    if (contentBox) {
        const onclickAttr = contentBox.getAttribute('onclick');
        if (onclickAttr && onclickAttr.includes('openNestedModal')) {
            e.preventDefault();
            e.stopPropagation();
            
            // Extract parameters from the onclick attribute
            const match = onclickAttr.match(/openNestedModal\(['"]([^'"]+)['"],\s*['"]([^'"]+)['"]\)/);
            if (match && match.length >= 3) {
                const title = match[1];
                // Replace escaped quotes to restore proper content
                const content = match[2].replace(/\\'/g, "'").replace(/\\"/g, '"');
                openNestedModal(title, content);
            }
        }
    }
});

// Same for touch events
document.addEventListener('touchend', function(e) {
    const contentBox = e.target.closest('.content-box');
    if (contentBox) {
        const onclickAttr = contentBox.getAttribute('onclick');
        if (onclickAttr && onclickAttr.includes('openNestedModal')) {
            e.preventDefault();
            e.stopPropagation();
            
            // Extract parameters from the onclick attribute
            const match = onclickAttr.match(/openNestedModal\(['"]([^'"]+)['"],\s*['"]([^'"]+)['"]\)/);
            if (match && match.length >= 3) {
                const title = match[1];
                // Replace escaped quotes to restore proper content
                const content = match[2].replace(/\\'/g, "'").replace(/\\"/g, '"');
                openNestedModal(title, content);
            }
        }
    }
}, { passive: false });
        
    // --- Particle System ---
    const canvas = document.getElementById('particle-canvas');
    const ctx = canvas.getContext('2d');
    let particlesArray = [];

    // Set canvas dimensions
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        // Re-initialize particles on resize if needed, or just adjust positions
        // For simplicity, we might not re-initialize here, but in a full app you might.
    });

    const particleThemeSettings = {
        'theme-default': {
            baseBg: '#e0e8f0',
            particleColor: 'rgba(60, 60, 60, 0.7)', // Dark grey for high contrast
            outlineColor: 'rgba(30, 30, 30, 0.9)',  // Very dark grey outline
            numParticles: 50, // Ensure particles are present
            particleSpeed: 0.5,
            particleSize: [3, 7],
            particleShape: ['circle', 'hollow-circle']
        },
        'theme-deep-ocean': {
            baseBg: '#0f2027',
            particleColor: 'rgba(44, 83, 100, 0.4)',
            outlineColor: 'rgba(20, 50, 70, 0.6)',
            numParticles: 60,
            particleSpeed: 0.3,
            particleSize: [4, 9],
            particleShape: ['square', 'hollow-square']
        },
        'theme-minty-fresh': {
            baseBg: '#D0E0E3',
            particleColor: 'rgba(176, 204, 208, 0.6)', // Light Muted Teal
            outlineColor: 'rgba(150, 180, 185, 0.8)',
            numParticles: 30, // Reduced for slower tweening effect
            particleSpeed: 0.4, // Adjusted speed for new shapes
            particleSize: [3, 7], // Adjusted size for new shapes
            particleShape: ['circle', 'hollow-circle']
        },
        'theme-cool-slate': {
            baseBg: '#455a64',
            particleColor: 'rgba(84, 110, 122, 0.4)',
            outlineColor: 'rgba(60, 80, 90, 0.6)',
            numParticles: 55,
            particleSpeed: 0.3,
            particleSize: [5, 10],
            particleShape: ['square', 'hollow-square', 'line']
        },
        'theme-earthy-tones': {
            baseBg: '#A0937D',
            particleColor: 'rgba(180, 165, 130, 0.4)',
            outlineColor: 'rgba(150, 140, 110, 0.6)',
            numParticles: 45,
            particleSpeed: 0.4,
            particleSize: [15, 25], // Larger triangles
            particleShape: ['triangle', 'hollow-triangle']
        },
        'theme-monochrome-calm': {
            baseBg: '#BDC3C7',
            particleColor: 'rgba(202, 207, 210, 0.5)',
            outlineColor: 'rgba(180, 185, 190, 0.7)',
            numParticles: 40,
            particleSpeed: 0.5,
            particleSize: [4, 9],
            particleShape: ['circle', 'hollow-circle']
        },
        'theme-forest-canopy': {
            baseBg: '#2F4F4F',
            particleColor: 'rgba(85, 107, 47, 0.4)', // Dark Olive Green
            outlineColor: 'rgba(60, 80, 25, 0.6)',
            numParticles: 30, // Reduced for slower tweening effect
            particleSpeed: 0.4, // Adjusted speed for new shapes
            particleSize: [5, 10], // Adjusted size for new shapes
            particleShape: ['triangle', 'hollow-triangle'] // Changed from line
        },
        'theme-stormy-sky': { // This is the original lightning, distinct from thunderstorm
            baseBg: 'linear-gradient(to bottom, #2c3e50, #34495e, #233142)',
            particleColor: 'rgba(255, 255, 224, 0.7)',
            outlineColor: 'rgba(241, 196, 15, 0.5)',
            numParticles: 15,
            particleSpeed: 1.5,
            particleSize: [20, 60],
            particleShape: 'lightning'
        },
        'theme-lightning-strike': { // This can be a more intense, focused lightning theme
            baseBg: '#101020',
            particleColor: 'rgba(220, 220, 255, 0.8)',
            outlineColor: 'rgba(180, 180, 255, 0.6)',
            numParticles: 10,
            particleSpeed: 2,
            particleSize: [30, 70],
            particleShape: 'lightning'
        },
        'theme-sky-clouds': {
            baseBg: '#87CEEB',
            particleColor: 'rgba(255, 255, 255, 0.7)',
            outlineColor: 'rgba(200, 200, 200, 0.5)',
            numParticles: 15,
            particleSpeed: 0.2,
            particleSize: [40, 80],
            particleShape: 'cloud'
        },
        'theme-sunset-gradient': {
            baseBg: 'linear-gradient(to bottom, #FF8C00, #FFD700, #F0E68C)',
            particleColor: 'rgba(255, 255, 255, 0.3)',
            outlineColor: 'rgba(255, 250, 205, 0.2)',
            numParticles: 30,
            particleSpeed: 0.2,
            particleSize: [2, 5],
            particleShape: ['circle', 'hollow-circle']
        },
        'theme-thunderstorm': {
            baseBg: '#050510', // Very dark blue/black
            particleColor: 'rgba(100, 150, 255, 0.9)', // Blue for lightning component
            outlineColor: 'rgba(50, 100, 255, 0.7)', // Blue for lightning component
            numParticles: 8, // e.g., 6 lightning, 2 thunder
            particleSpeed: 3.5,   // Faster lightning (thunder has internal timing)
            particleSize: [30, 80], // For lightning length and thunder maxRadius
            particleShape: ['lightning', 'thunder'], // Mix of shapes
            thunderCount: 2 // Max number of thunder particles at a time
        }
        // Soft Lavender removed
    };

    class Particle {
        constructor(settings) {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.size = Math.random() * (settings.particleSize[1] - settings.particleSize[0]) + settings.particleSize[0];
            this.speedX = (Math.random() * 2 - 1) * settings.particleSpeed; // Used by non-line/thunder
            this.speedY = (Math.random() * 2 - 1) * settings.particleSpeed; // Used by non-line/thunder
            this.color = settings.particleColor;
            this.outlineColor = settings.outlineColor || 'rgba(0,0,0,0.1)';
            this.settings = settings; // Store settings

            // Determine shape, especially if it's an array (like for thunderstorm)
            if (Array.isArray(settings.particleShape)) {
                if (settings.particleShape.includes('thunder') && settings.particleShape.includes('lightning')) {
                    let thunderParticlesCount = particlesArray.filter(p => p.shape === 'thunder').length;
                    if (thunderParticlesCount < (settings.thunderCount || 2) && Math.random() < 0.3) {
                        this.shape = 'thunder';
                    } else {
                        this.shape = 'lightning';
                    }
                } else {
                     this.shape = settings.particleShape[Math.floor(Math.random() * settings.particleShape.length)];
                }
            } else {
                this.shape = settings.particleShape || 'circle';
            }

            if (this.shape === 'line') {
                this.lineLength = this.size; // Length is based on initial size
                this.angle = Math.random() * Math.PI * 2; // Angle set ONCE at construction
                this.targetX = Math.random() * canvas.width;
                this.targetY = Math.random() * canvas.height;
                this.tweenSpeed = settings.particleSpeed;
            } else if (this.shape === 'thunder') {
                this.currentRadius = 0;
                this.maxRadius = this.size;
                this.life = 30 + Math.random() * 30;
                this.initialLife = this.life;
                this.alpha = 1;
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
            } else if (this.shape === 'lightning') {
                this.speedX = (Math.random() * 2 - 1) * settings.particleSpeed * (Math.random() * 0.5 + 0.5);
                this.speedY = settings.particleSpeed * (Math.random() * 1 + 0.8);
            }
        }
        update() {
            if (this.shape === 'line') {
                let dx = this.targetX - this.x;
                let dy = this.targetY - this.y;
                let dist = Math.sqrt(dx * dx + dy * dy);

                if (dist > 1) {
                    this.x += dx * this.tweenSpeed;
                    this.y += dy * this.tweenSpeed;
                } else { // Reached target
                    this.targetX = Math.random() * canvas.width;
                    this.targetY = Math.random() * canvas.height;
                    // Ensure angle is NOT changed here: this.angle = Math.random() * Math.PI * 2;
                }
            } else if (this.shape === 'thunder') {
                if (this.life > 0) {
                    this.currentRadius += (this.maxRadius - this.currentRadius) * 0.15;
                    this.alpha = (this.life / this.initialLife);
                    this.life--;
                } else {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.currentRadius = 0;
                    this.life = 30 + Math.random() * 30;
                    this.initialLife = this.life;
                    this.maxRadius = this.settings.particleSize[0] + Math.random() * (this.settings.particleSize[1] - this.settings.particleSize[0]);
                    this.alpha = 1;
                }
            } else if (this.shape === 'lightning') {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.y > canvas.height + this.size || this.x < -this.size || this.x > canvas.width + this.size) {
                    this.y = -this.size;
                    this.x = Math.random() * canvas.width;
                    this.speedX = (Math.random() * 2 - 1) * this.settings.particleSpeed * (Math.random() * 0.5 + 0.5);
                    this.size = this.settings.particleSize[0] + Math.random() * (this.settings.particleSize[1] - this.settings.particleSize[0]);
                }
            }
             else {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.shape !== 'cloud' && this.size > 0.2) this.size -= 0.01;

                if (this.x < 0) this.x = canvas.width;
                if (this.x > canvas.width) this.x = 0;
                if (this.y < 0) this.y = canvas.height;
                if (this.y > canvas.height) this.y = 0;
            }
        }
        draw() {
            ctx.beginPath();
            const isHollow = this.shape.startsWith('hollow-');
            let actualShape = isHollow ? this.shape.substring(7) : this.shape;
            const outlineWidth = Math.max(1, this.size / 15);

            if (actualShape === 'thunder') {
                if (this.life > 0) {
                    ctx.fillStyle = `rgba(100, 150, 255, ${this.alpha * 0.5})`; // Blue splash fill
                    ctx.strokeStyle = `rgba(150, 200, 255, ${this.alpha * 0.7})`; // Brighter blue splash stroke
                    ctx.lineWidth = this.currentRadius * 0.03 + 1;
                }
            } else if (isHollow || actualShape === 'line' || actualShape === 'lightning') {
                ctx.strokeStyle = this.color;
                ctx.lineWidth = outlineWidth;
            } else {
                ctx.fillStyle = this.color;
                ctx.strokeStyle = this.outlineColor;
                ctx.lineWidth = outlineWidth;
            }

            if (actualShape === 'square') {
                ctx.rect(this.x - this.size / 2, this.y - this.size / 2, this.size, this.size);
            } else if (actualShape === 'triangle') {
                const height = this.size * Math.sqrt(3) / 2;
                ctx.moveTo(this.x, this.y - height / 2);
                ctx.lineTo(this.x - this.size / 2, this.y + height / 2);
                ctx.lineTo(this.x + this.size / 2, this.y + height / 2);
                ctx.closePath();
            } else if (actualShape === 'line') {
                ctx.moveTo(this.x, this.y);
                const endX = this.x + Math.cos(this.angle) * this.lineLength;
                const endY = this.y + Math.sin(this.angle) * this.lineLength;
                ctx.lineTo(endX, endY);
            } else if (actualShape === 'lightning') {
                ctx.moveTo(this.x, this.y);
                let currentX = this.x;
                let currentY = this.y;
                const segments = 5 + Math.floor(Math.random() * 5);
                const segmentLength = this.size / segments;
                for (let i = 0; i < segments; i++) {
                    const nextX = currentX + (Math.random() - 0.5) * segmentLength * 2.5;
                    const nextY = currentY + segmentLength + (Math.random() - 0.8) * segmentLength * 0.5;
                    ctx.lineTo(nextX, nextY);
                    currentX = nextX;
                    currentY = nextY;
                }
            } else if (actualShape === 'cloud') {
                const s = this.size / 3;
                ctx.arc(this.x, this.y, s * 1.2, 0, Math.PI * 2);
                ctx.arc(this.x + s * 0.9, this.y + s * 0.4, s, 0, Math.PI * 2);
                ctx.arc(this.x - s * 0.8, this.y + s * 0.5, s * 0.9, 0, Math.PI * 2);
                ctx.arc(this.x + s * 0.3, this.y - s * 0.6, s * 0.8, 0, Math.PI * 2);
                ctx.closePath();
            } else if (actualShape === 'thunder') {
                if (this.life > 0) {
                    ctx.arc(this.x, this.y, this.currentRadius, 0, Math.PI * 2);
                }
            } else {
                ctx.arc(this.x, this.y, this.size / 2, 0, Math.PI * 2);
            }

            if (actualShape === 'thunder') {
                if (this.life > 0) {
                    ctx.fill();
                    if (this.currentRadius > 2) ctx.stroke();
                }
            } else if (isHollow || actualShape === 'line' || actualShape === 'lightning') {
                ctx.stroke();
            } else {
                ctx.fill();
                if (this.outlineColor && this.outlineColor !== 'none' && actualShape !== 'cloud') {
                    ctx.stroke();
                }
            }
        }
    }

    function initParticles(themeName) {
        particlesArray = []; // Clear existing particles
        const settings = particleThemeSettings[themeName] || particleThemeSettings['theme-default'];
        const numParticles = settings.numParticles;

        for (let i = 0; i < numParticles; i++) {
            // The constructor now handles mixed shape logic for themes like 'thunderstorm'
            particlesArray.push(new Particle(settings));
        }
    }

    function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < particlesArray.length; i++) {
            particlesArray[i].update();
            particlesArray[i].draw();
        }
        requestAnimationFrame(animateParticles);
    }

    function updateParticleTheme(themeName) {
        const settings = particleThemeSettings[themeName] || particleThemeSettings['theme-default'];
        // document.body.style.backgroundColor = settings.baseBg; // OLD: Problematic for gradients
        if (settings.baseBg && typeof settings.baseBg === 'string' && !settings.baseBg.includes('gradient')) {
            document.body.style.backgroundColor = settings.baseBg; // Set solid base BG for non-gradient themes
        }
        // If it's a gradient, the CSS class on the body (set by theme switcher) will handle the background.
        initParticles(themeName); // Re-initialize particles with new theme settings
    }

    // --- Theme Switcher Logic (Modified) ---
    const themeSwitcherBtn = document.getElementById('theme-switcher'); // Renamed to avoid conflict if 'themeSwitcher' is used elsewhere
    const body = document.body;
    // Ensure 'theme-soft-lavender' is removed if it was still in your array from a previous step
    const themes = ['theme-default', 'theme-deep-ocean', 'theme-minty-fresh', 'theme-cool-slate', 'theme-earthy-tones', 'theme-monochrome-calm', 'theme-forest-canopy', 'theme-stormy-sky', 'theme-lightning-strike', 'theme-sky-clouds', 'theme-sunset-gradient', 'theme-thunderstorm'];
    let currentThemeIndex = 0;

    // Apply default theme and particles initially
    body.classList.add(themes[currentThemeIndex]);
    updateParticleTheme(themes[currentThemeIndex]); // Initialize particles for the default theme

    function handleThemeSwitch(event) {
        if (event.type === 'touchend') {
            event.preventDefault(); // Prevent ghost clicks and ensure consistent behavior
        }

        // Remove current theme class
        body.classList.remove(themes[currentThemeIndex]);

        // Increment theme index
        currentThemeIndex = (currentThemeIndex + 1) % themes.length;
        const newThemeName = themes[currentThemeIndex];

        // Add new theme class
        body.classList.add(newThemeName);

        // Special handling for gradient background themes for the particle canvas
        const newThemeSettings = particleThemeSettings[newThemeName] || particleThemeSettings['theme-default'];
        if (typeof newThemeSettings.baseBg === 'string' && newThemeSettings.baseBg.includes('gradient')) {
            // If it's a gradient, the body class handles the background via CSS.
        } else {
            // For solid colors, body class also handles it, but this was the existing logic structure.
        }
        // Update particle system for the new theme
        updateParticleTheme(newThemeName);
    }

    themeSwitcherBtn.addEventListener('click', handleThemeSwitch);
    themeSwitcherBtn.addEventListener('touchend', handleThemeSwitch, { passive: false });

    animateParticles(); // Start the particle animation loop
    </script>
</body>
</html>
